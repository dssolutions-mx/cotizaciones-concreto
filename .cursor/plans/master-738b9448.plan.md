<!-- 738b9448-9229-4597-a688-297f08863218 f9a5522a-329c-4d86-b491-ea90d077ce80 -->
# Master Recipe Creation & Variant Governance (Dual-Mode)

### Goals

- Make recipe_code = ARKIK long code (canonical); deprecate arkik_long_code.
- Govern variant lifecycle: on same-spec recipes, ask user to create new variant or update existing.
- Keep system working while masters are grouped: master-first pricing, variant fallback.
- Add complete UI protocol for grouping, plus end-to-end backfill across DB and app.

### Data Model & Migrations (via Supabase MCP)

- Unique per plant: (plant_id, recipe_code).
- Backfill canonicalization: set recipe_code = arkik_long_code when different.
- Transitional guard: arkik_long_code IS NULL OR arkik_long_code = recipe_code.
- Do not drop arkik_long_code yet; remove after rollout and validation.
```sql
-- Unique per plant
CREATE UNIQUE INDEX IF NOT EXISTS ux_recipes_plant_code ON recipes(plant_id, recipe_code);

-- Backfill canonicalization
UPDATE recipes SET recipe_code = arkik_long_code
WHERE arkik_long_code IS NOT NULL AND arkik_long_code <> recipe_code;

-- Guard (transitional)
ALTER TABLE recipes ADD CONSTRAINT ck_arkik_equals_recipe_code
CHECK (arkik_long_code IS NULL OR arkik_long_code = recipe_code);
```


### Manual Recipe Creation (src/components/recipes/AddRecipeModal.tsx)

- Compute ARKIK long code and assign to recipe_code before insert.
- Remove post-insert arkik_long_code updates.
- Preflight:
  - Find same-spec recipes in plant (fc, age d/h, placement, TMA, slump).
  - If matches: modal → Create new variant vs Update existing variant (pick code / rename).
  - On recipe_code collision: force decision (update or change code).
- Enforce uniqueness per plant in client; handle DB errors gracefully.

### Calculator Flow (src/components/calculator/ConcreteMixCalculator.tsx + src/lib/services/calculatorService.ts)

- Keep recipe_code = computed ARKIK long.
- Remove arkik_long_code updates; use recipe_code only.
- Batch preflight modal for selected rows:
  - Same-spec matches: choose update existing or create new variant.
  - recipe_code collisions: choose update existing or rename.
  - Apply per-row strategy and pass to save.

### Variant Governance Logic (shared helper)

- Helper: `findSameSpecRecipes(plantId, spec)`, `decideVariantAction(specMatches[], recipe_code)`.
- Spec equality: strength_fc, age_days/age_hours, placement_type, max_aggregate_size, slump (exclude application_type, has_waterproofing, performance_grade).
- Reuse in manual and calculator flows.

### UI Grouping Protocol (MasterRecipeGroupingInterface)

- Component: `src/components/masters/MasterRecipeGroupingInterface.tsx`.
- Data source: suggestions from SQL (variant_analysis → suggested_master_code, variant list, same specs).
- Cards per suggested group show: specs summary, variant list, usage counts (orders/remisiones 90d), pricing snapshot.
- Actions per group:

1) Create Master (validate unique master_code per plant).

2) Link Variants (update `recipes.master_recipe_id`, compute and store `variant_suffix` from recipe_code: last two segments 'num-variante').

3) Pricing Impact Preview (pipe to PriceConflictResolver if multi-price).

4) Execute (atomic flow: create master → link variants → queue/resolve pricing conflicts → write audit).

5) Undo (admin-only before price migration): unlink variants, deactivate master.

- Bulk actions: Approve all “clean” groups (no conflicts, no recent usage) → queue others for manual.
- Validation rules: identical core specs; master_code uniqueness; warnings on recent usage; conflicts summarized.
- Audit trail: store user, timestamp, before/after group membership.

### Price Conflict Resolver UI

- Component: `src/components/masters/PriceConflictResolver.tsx`.
- Inputs: master, client/site, variant price rows (product_prices + quote_details approved).
- Options per MD: Most recent, Highest, Lowest, Manual.
- Output: write/activate a single master-level price; optionally deactivate variant prices.

### Transitional Operation (No Downtime)

- Feature flags:
  - `features.masterGroupingEnabled` (expose UI).
  - `features.masterPricingEnabled` (toggle master-first pricing in live flows).

- During migration (masterPricingEnabled off):
  - Pricing in validators, orders, and quotes uses variant prices only (recipes/product_prices via recipe_id; approved quote_details via recipe_id).
  - QuoteBuilder stays in variant mode; users select recipe (ARKIK code) as today.
  - Arkik validator matches by recipe_code (ARKIK) and resolves price from variant; writes remisiones without master_recipe_id unless already linked.
  - Reports may show by-master aggregations when linkage exists; otherwise aggregate by recipe.

- After migration (masterPricingEnabled on):
  - Pricing becomes master-first with variant fallback.
  - QuoteBuilder switches to master selection; `quote_details.master_recipe_id` is primary, `recipe_id` optional.
  - Arkik validator resolves master from matched recipe; pricing from master else variant.
  - Can be enabled per plant.

### Backfill Across Tables & Services (via Supabase MCP)

1) Master backfill (safe, idempotent):

```sql
-- Suggest master groups by core specs (as in MD Step 1.1)
-- For each group:
--  a) INSERT INTO master_recipes (unique master_code per plant)
--  b) UPDATE recipes SET master_recipe_id = new_master.id,
--     variant_suffix = REGEXP_REPLACE(recipe_code, '.*-([^-]+-[^-]+)$', '\1')
```

2) Pricing migration (MD Step 2.3):

- Create master-level product_prices where absent; preserve most recent rule for conflicts resolved in UI.
- Update `quote_details`, `order_items`, `remisiones` to set `master_recipe_id` where recipe_id has a master.
- Limit remisiones update to a recent window first (e.g., 90 days), expand after QA.

3) Validation queries (MD Step 2.4): run V1–V5 and fix any findings.

### Component & Query Update Matrix

- Quotes: `src/components/prices/QuoteBuilder.tsx` → `MasterRecipeSelector`; write `master_recipe_id` to `quote_details`.
- Orders: creation/matching ensure `master_recipe_id` on `order_items` when available; keep variant in `recipe_id` for production traceability.
- Arkik validators: prefer `recipe_code`; pricing master-first fallback.
- ArkikProcessor/ValidationTable: search by `recipe_code` primarily; display `recipe_code`.
- Recipe list/search: display `recipe_code`, include master linkage and variant_suffix.
- Reports: add `getVolumeByMaster` and views from MD; replace variant-fragmented reports where applicable.

### Testing

- Unit: same-spec detection; variant decision flows; collision handling; helpers.
- Integration: grouping UI end-to-end (create master, link variants, resolve price); dual-mode pricing; Arkik upload with only `recipe_code`.
- Data validation: V1–V5 green after backfill; re-run post-rollout.

### Rollout & Cleanup

- Phase 1: Ship canonical `recipe_code`, grouping UI, master-first fallback; keep arkik_long_code guard.
- Phase 2: Complete price backfill, set master_recipe_id on references; enable master-first UI in quotes.
- Phase 3: Remove arkik_long_code guard; plan removal of arkik_long_code column when telemetry stable.

### Files to Update (primary)

- `src/components/recipes/AddRecipeModal.tsx`
- `src/lib/services/calculatorService.ts`
- `src/components/calculator/ConcreteMixCalculator.tsx`
- `src/components/masters/MasterRecipeGroupingInterface.tsx` (new)
- `src/components/masters/PriceConflictResolver.tsx` (new)
- `src/components/prices/QuoteBuilder.tsx`
- `src/services/debugArkikValidator.ts` and/or `src/services/arkikValidator.ts`
- `src/services/arkikOrderCreator.ts`
- `src/components/arkik/ValidationTable.tsx`
- `src/components/recipes/RecipeList.tsx`
- `src/lib/supabase/recipes.ts`
- `src/lib/supabase/reports.ts` (add by-master report)

### To-dos

- [x] Add unique constraint, backfill canonicalization, transitional check constraint for recipes
- [x] Implement MasterRecipeGroupingInterface with hierarchical visual grouping (Strength→Slump→Placement)
- [x] Implement PriceConflictResolver and wire into grouping flow
- [x] Batch preflight in calculator; preflight in manual form (same-spec + collisions)
- [x] Set recipe_code from ARKIK long; remove arkik_long_code updates
- [x] Create DB schema (master_recipes table, columns, indexes, RPC)
- [x] Update validators/order creation to master-first pricing with variant fallback
- [x] Replace UI displays/search from arkik_long_code to recipe_code; add by-master reports
- [x] Add RLS policies and database views
- [x] Add unit tests + validation suite queries

**USER-DRIVEN EXECUTION (No code changes needed):**
- [ ] Phase 1: Recipe grouping via `/masters/grouping` UI (Commercial+Quality, 1-2 weeks)
- [ ] Phase 2: Price consolidation via `/masters/pricing` UI (Commercial+Accounting, 1 week)  
- [ ] Phase 3: Enable NEXT_PUBLIC_FEATURE_MASTER_PRICING=true in production

**Pages Created:**
- `/masters/grouping` - Hierarchical grouping interface (Strength → Slump → Placement)
- `/masters/pricing` - Price conflict resolution and consolidation